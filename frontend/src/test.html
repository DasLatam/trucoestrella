<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Conexión - Truco Estrella</title>
    <style>
        body { font-family: sans-serif; background-color: #111827; color: #e5e7eb; padding: 2rem; }
        .container { max-width: 800px; margin: auto; background-color: #1f2937; padding: 2rem; border-radius: 8px; }
        input, button { padding: 0.75rem; border-radius: 4px; border: 1px solid #4b5563; background-color: #374151; color: white; margin-right: 0.5rem; }
        button { cursor: pointer; background-color: #f59e0b; color: #1f2937; font-weight: bold; }
        button:hover { background-color: #fbbf24; }
        #logs { margin-top: 1.5rem; background-color: #111827; padding: 1rem; border-radius: 4px; height: 400px; overflow-y: scroll; white-space: pre-wrap; font-family: monospace; }
        .log-connect { color: #34d399; }
        .log-event { color: #60a5fa; }
        .log-error { color: #f87171; }
        h1, h2 { color: #f59e0b; }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>Test de Conexión Directa</h1>
        <p>Abre la consola del navegador (F12) y esta misma página en otra pestaña para probar la unión a una sala.</p>

        <div>
            <h2>Paso 1: Conectar</h2>
            <input type="text" id="playerName" placeholder="Tu Nombre">
            <button id="connectButton">Conectar</button>
            <p><strong>Estado:</strong> <span id="status">Desconectado</span></p>
            <p><strong>Socket ID:</strong> <span id="socketId">N/A</span></p>
        </div>

        <hr style="border-color: #4b5563; margin: 2rem 0;">

        <div>
            <h2>Paso 2: Acciones</h2>
            <input type="text" id="roomId" placeholder="ID de la Sala para unirse">
            <br><br>
            <button id="createGameButton" disabled>Crear Partida (1v1)</button>
            <button id="joinRoomButton" disabled>Unirse a Sala</button>
        </div>

        <h2>Logs del Servidor</h2>
        <div id="logs"></div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const socketIdEl = document.getElementById('socketId');
        const logsEl = document.getElementById('logs');
        const connectButton = document.getElementById('connectButton');
        const createGameButton = document.getElementById('createGameButton');
        const joinRoomButton = document.getElementById('joinRoomButton');
        const playerNameInput = document.getElementById('playerName');
        const roomIdInput = document.getElementById('roomId');

        let socket;

        function log(message, type = '') {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (type) {
                p.className = `log-${type}`;
            }
            logsEl.appendChild(p);
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        connectButton.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
            }

            log('Intentando conectar a wss://trucoestrella-backend.onrender.com...');
            
            socket = io('https://trucoestrella-backend.onrender.com', {
                transports: ['websocket', 'polling']
            });

            // --- LISTENERS ---
            socket.on('connect', () => {
                statusEl.textContent = 'Conectado';
                statusEl.style.color = '#34d399';
                socketIdEl.textContent = socket.id;
                createGameButton.disabled = false;
                joinRoomButton.disabled = false;
                log(`Conectado exitosamente. Socket ID: ${socket.id}`, 'connect');
            });

            socket.on('disconnect', () => {
                statusEl.textContent = 'Desconectado';
                statusEl.style.color = '#f87171';
                socketIdEl.textContent = 'N/A';
                createGameButton.disabled = true;
                joinRoomButton.disabled = true;
                log('Desconectado del servidor.', 'error');
            });

            socket.on('game-created', (gameData) => {
                log(`Partida creada! ID: ${gameData.roomId}. Copia este ID y pégalo en la otra pestaña para unirte.`, 'event');
                log(JSON.stringify(gameData, null, 2));
                roomIdInput.value = gameData.roomId;
            });

            socket.on('update-room', (gameData) => {
                log('Actualización de la sala recibida.', 'event');
                log(JSON.stringify(gameData, null, 2));
            });

            socket.on('error-message', (message) => {
                log(`ERROR: ${message}`, 'error');
            });
        });

        createGameButton.addEventListener('click', () => {
            const playerName = playerNameInput.value;
            if (!playerName) {
                alert('Por favor, ingresa un nombre.');
                return;
            }
            log(`Emitiendo 'create-game' con el nombre: ${playerName}`);
            socket.emit('create-game', { playerName, gameMode: '1v1', vsAI: false });
        });

        joinRoomButton.addEventListener('click', () => {
            const playerName = playerNameInput.value;
            const roomId = roomIdInput.value;
            if (!playerName || !roomId) {
                alert('Por favor, ingresa un nombre y un ID de sala.');
                return;
            }
            log(`Emitiendo 'join-room' para la sala ${roomId} con el nombre: ${playerName}`);
            socket.emit('join-room', { roomId, playerName });
        });

    </script>
</body>
</html>
